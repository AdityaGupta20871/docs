import { Callout } from "nextra-theme-docs";
import Navigation from "components/navigation";

# Spheron Compute SDK

The Spheron Compute SDK is a npm package, that provides support for working with Spheron Compute organizations.

<Callout type="info">
  **NOTE:** The package is only meant for Node.js environments and will not work
  in a browser or frontend apps.
</Callout>

## Installation

**Using NPM**

```
npm i @spheron/compute
```

**Using Yarn**

```
yarn add @spheron/compute
```

## Usage

To use the Spheron Compute SDK, you have to create an instance of `SpheronClient`.

```js
import { SpheronClient, ProtocolEnum } from "@spheron/compute";

const client = new SpheronClient({ token });
```

The `SpheronClient` constructor takes an object that has one property `token`.
Follow the instructions in the [DOCS](https://docs.spheron.network/rest-api/#creating-an-access-token) to generate this token.
The `SpheronClient` has three properties:

- `organization` provides methods for working with organizations.
- `cluster` provides methods for working with cluster.
- `instance` provides methods for working with specific instance.
- `computeMarketplace` provides methods for getting information about marketplace apps.
- `computeMachine` provides methods for getting information about available compute machines.


<Callout type="info">
  **NOTE:** When you are creating the tokens, please choose **Compute** type in
  the dashboard.
</Callout>

## Organization

The methods for working with organizations are available on the `organization` property of the `SpheronClient` object.

### get

Used to get the organization based on the passed id.

```js
const organization: Organization = await spheron.organizations.get();
```

Returns an Organization object.

```js
interface Organization {
  id: string;
  profile: {
    name: string,
    username: string,
    image: string,
  };
}
```

<Callout type="info">
  **NOTE:** At the moment, Spheron Tokens are scoped to a single organization.
  So you can only use them to get the information about the organization for
  which you have created the token.
</Callout>

---

### getClusters

Used to get the clusters of the organization. The method supports pagination.

```js
const clusters: Cluster[] = await spheron.organizations.getClusters(options: {
  skip: 0,
  limit: 10
});
```

Params:

- `options`:
  - `skip`: number of clusters to skip.
  - `limit`: number of clusters to take.

Return an array of clusters. Checkout the [get cluster section for more details on the cluster interface properties](/sdk/compute/#get-1).

### getUsage

Used to get the current subscription usage of the organization.

```js
const usage: UsageWithLimits = await spheron.organizations.getUsage();
```

Returns the `UsageWithLimits` object.

```js
interface UsageWithLimits {
    used: {
    computeCredit?: number; // the amount used by organization, in usd
    computeBuildExecution?: number; // the time used for builds, in seconds
    numberOfRequests?: number; //the number of requests organization has had until now
    bandwidth?: number; //the bytes of bandwith used for current subscription
    domains?: number; //the number of domains and subdomains an organization has
  };
  limit: {
    computeCredit?: number; // the amount limit for organization, in usd
    computeBuildExecution?: number; // the time limit for builds, in seconds
    bandwidth?: number; //the limit of bandwith for subscription
    domains?: number; //the limit on how many domains and subdomains can an organization have
  };
}
```

## Cluster

The methods for working with clusters are available on the `cluster` property of the `SpheronClient` object.

### get

Used to get the cluster based on the passed Id.

```js
const cluster: Cluster = await spheron.cluster.get(clusterId);
```

Params:

- Id of the cluster.

Returns an object of type `Cluster`.

```js
interface Cluster {
  id: string; //id of a cluster
  name: string; //name of a cluster
  url: string; //docker image
  proivder: ProviderEnum; //docker image provider (currently only dockerhub is supported)
  createdBy: string; //id of the user that created cluster
  state: ClusterStateEnum; //state of a cluster
  createdAt: Date; 
  updatedAt: Date;
};

enum ProviderEnum {
    DOCKERHUB = "DOCKERHUB"
};

enum ClusterStateEnum {
    MAINTAINED = "MAINTAINED",
    ARCHIVED = "ARCHIVED"
};
```

---

### delete

Used to delete a cluster.

```js
await spheron.cluster.delete(clusterId);
```

Method return type is void. If there is an issue while archiving, an error will be thrown.

<Callout type="info">
  **NOTE:** Clusters with running instances cannot be deleted.
</Callout>

---

### getInstancesInfo

Used for getting information about instances in cluster.

```js
await spheron.cluster.getInstancesInfo(clusterId);
```

Returns an object of type `InstancesInfo`.

```js
interface InstancesInfo {
    active: number; //number of active instances in cluster
    starting: number; //number of starting instances in cluster
    failedToStart: number; //number of fail to start instances in cluster
    closed: number; //number of closed instances in cluster
    total: number; //total number of instances in cluster
}
```

---

### getUsage

Used to getting the current funds usage of the cluster.

```js
const clusterUsage: ClusterFundsUsage = await spheron.cluster.getUsage(clusterId);
```

Params:

- Id of the cluster.

Returns an object of type `ClusterFundsUsage`.

```js
interface ClusterFundsUsage {
    dailyUsage: number; //cluster daily usage in usd
    usedTillNow: number; //cluster daily usage in usd
}
```

---

### getInstances

Used to get the list of instances in th cluster. The method supports pagination.

```js
const instances: InstanceDetailed[] =
  await spheron.instance.getInstances(
    instanceId,
    options: {
      skip: 0,
      limit: 10
    }
  );
```

Params:

- Id of the cluster.
- `options`:
  - `skip`: number of instances to skip.
  - `limit`: number of instances to take.

Returns an array of `InstanceDetailed` objects. Checkout the [get instance section for more details on the instance interface properties](/sdk/compute/#get-2)

```js
interface InstanceDetailed {
  id: string; //id of a istance
  state: InstanceStateEnum; //state of a instance
  name: string; //name of a instance
  deployments: Array<string>; //list of all instance deployment ids
  cluster: string; //instance cluster id
  activeDeployment: string; //id of active deployment
  latestUrlPreview: string; //latest instance url
  agreedMachine: MachineImageType; //compute machine information
  healthCheck: HealthCheck; //instance health check endpoint information
  cpu: number; //compute machine cpu
  memory: string; //compute machine memory
  storage: string; //compute machine storage
  image: string; //docker image
  tag: string; //docker tag
  createdAt: Date;
  updatedAt: Date;
}
```

## Instance

The methods for working with instances are available on the `instance` property of the `SpheronClient` object.

---

### create

Used for deploying new instance.

```js
const instanceResponse: InstanceResponse =
  await spheron.instance.create(creationConfig: {
  clusterName: "hello world",
  configuration: {
    image: "crccheck/hello-world",
    tag: "latest",
    scale: 1,
    ports: [{ containerPort: 8000, exposedPort: 8000 }],
    env: [],
    commands: [],
    args: [],
    region: "any",
    machineImageName: "Ventus Small"
  },
  healthCheckConfig: {
    path: "/",
    port: 8000
  }
});
```

Params:

- `clusterName`: name of cluster
- `configuration`: the name of the variable.
  - `image`: dockerhub image url (should be publicly available).
  - `tag`: tag for docker image.
  - `scale`: number of instances that should be created.
  - `ports`: list of port mappings.
  - `env`: list of environment variables.
  - `commands`: list of executables for docker CMD command
  - `args`: list of params for docker CMD command 
  - `region`: region in which to deploy instance. List of available can be acquired from [getRegions section under compute machine section](/sdk/compute/#getregions)
  - `machineImageName`: name of machine image which should be used for deploying instance. List of available can be aquierd from [get section under compute machine section](/sdk/compute/#get-4)
  - `healthCheckConfig`:
    - `path`: path on which health check should be done
    - `port`: container port on which health check should be done

- `Port`: 
  - `containerPort`: container port that will be mapped
  - `exposedPort`: port to be mapped to

<Callout type="info">
  **NOTE:** At the moment, only mapping to port 80 can be guarantied. For all the others, container port will be mapped to random port asigned on instance deployment.
  - \{ containerPort: 3000, exposedPort: 80 \} - port 3000 will be mapped to port 80
  - \{ containerPort: 3000, exposedPort: 3000 \} - port 3000 will be mapped to randpom port
</Callout>

- `EnvironmentVar`: 
  - `key`: key of environment variable
  - `value`: value of environment variable
  - `isSecret`: should environment variable be secret

Returns `InstanceResponse` object, indicating instance deployment has started.

```js
interface InstanceResponse {
  clusterId: string; //id of cluster instance is deployed in
  instanceId: string;  //id of instance
  instanceDeploymentId: string;  //id of instance deployment
}
```

---

### get

Used to get Instance based on the passed id.

```js
const instance: Instance = await spheron.instance.get(instanceId);
```

Params:

- Id of the instance.

Returns object of a type `Instance`.

```js
interface Instance {
  id: string; //id of a istance
  state: InstanceStateEnum; //state of a instance
  name: string; //name of a instance
  deployments: Array<string>; //list of all instance deployment ids
  cluster: string; //instance cluster id
  activeDeployment: string; //id of active deployment
  latestUrlPreview: string; //latest instance url
  agreedMachine: MachineImageType; //compute machine information
  healthCheck: HealthCheck; //instance health check endpoint information
  createdAt: Date;
  updatedAt: Date;
};

interface MachineImageType {
    machineName: string; //compute machine type
    agreementDate: number; //date of deploying instance
}

enum InstanceStateEnum {
    STARTING = "Starting",
    FAILED_START = "Failed-start",
    ACTIVE = "Active",
    CLOSED = "Closed"
};

interface HealthCheck {
    path: string; //healthcheck path
    port: Port; //cotainer port on which healthcheck should be done
    status: HealthStatusEnum; //latest health check status
    timestamp: Date; //timestamp of last health check
};

```

---

### delete

Used to delete a instance.

```js
await spheron.instance.delete(instanceId);
```

Method return type is void. If there is an issue while deleting, an error will be thrown.

---

### update

Used to update instance.

```js
await spheron.instance.update(
  instanceId,
  {
    env: [{ key: "key", value: "value", isSecret: false }],
    commands: ["executable"],
    args: ["param"],
    tag: "latest";
  }
);
```

Params:
- `env`: list of environment variables.
- `commands`: list of executables for docker CMD command 
- `args`: list of params for docker CMD command 
- `tag`: tag for docker image.

Returns `InstanceResponse` object, indicating instance update has started.

```js
interface InstanceResponse {
  clusterId: string; //id of cluster instance is deployed in
  instanceId: string;  //id of instance
  instanceDeploymentId: string;  //id of instance deployment
}
```

### updateHealthCheck

Used to update endpoint used for instance health check.

```js
const updated = await spheron.instance.updateHealthCheck(
  instanceId,
  { path: "/health", cointainerPort: 3000 }
);
```

Params:

- Id of the project.
- Id of the environment variable.
- `healthCheck`:
  - `path`: health check path
  - `cointainerPort`: container port on which health check should be done

Returns the response indicating if update was successful.

```js
{ 
  message: string; //update message
  updated: boolean; //is updated
}
```

---

### close

Used to close the instance.

```js
const closed = await spheron.instance.close(instanceId);
```

Params:

- Id of the instance.

Returns the response indicating if update was successful.

```js
{ 
  message: string; //close message
  success: boolean; //is successful
}
```

---

### getInstanceDeployment

Used to get the instance deployment.

```js
const deploymentResponse: { deployment: InstanceDeployment; liveLogs: string[] } =
  await spheron.instance.getInstanceDeployment(deploymentId);
```

Params:

- Id of the instance deployment.

Returns an `InstanceDeployment` object and list of live logs.

```js
interface InstanceDeployment {
  id: string; //id of deployment
  type: DeploymentTypeEnum; //type of deployment
  status: DeploymentStatusEnum; //status of deployment
  buildTime: number; //deployment build time
  env: any; //deployment environtment
  logs: [{ time: string; log: Array<string> }]; //list of deployment logs
  closingLogs: [{ time: string; log: string }]; //list of deployment closing logs
  clusterLogs: Array<string>; //list of cluster logs
  clusterEvents: Array<string>; //list of cluster events
  instance: string; //id of instance
  urlPrewiew: string; //connection url
  deploymentInitiator: string; //userId that initiated deployment
  instanceConfiguration: {
    image: string; //docker image
    tag: string; //docker image tag
    scale: number; //number of instances
    ports: Array<Port>; //port mappings
    env: Array<EnvironmentVar>; //environment variables
    commands: Array<string>; //list of executables for docker CMD command 
    args: Array<string>; //list of params for docker CMD command 
    region: string; //region to which instance is deployed
    agreedMachineImage: MachineImageType
  };
};

enum DeploymentTypeEnum {
  DEPLOY = "DEPLOY",
  UPDATE = "UPDATE",
}

enum DeploymentStatusEnum {
  QUEUED = "Queued",
  PENDING = "Pending",
  DEPLOYED = "Deployed",
  FAILED = "Failed",
  DEPRECATED = "Deprecated",
  DEPRECATED_PROVIDER = "Deprecated-Provider",
};

interface Port {
    containerPort: number; //container port
    exposedPort: number; //eposed port container port is mapped to
};

interface EnvironmentVar {
  key: string; //environment variable key 
  value: string; //environment variable value 
  isSecret: boolean; //is environment variable secret 
};

interface MachineImageType {
    machineName: string; //compute machine name
    agreementDate: number; //date of deploying instance
    cpu?: number; //compute machine cpu
    memory?: string; //compute machine memory
    storage?: string; //compute machine storage
    persistentStorage?: PersistentStorage; //persistent storege information
}

interface PersistentStorage {
    size: string;
    class: PersistentStorageClassEnum;
    mountPoint: string;
};
```

---

### getInstanceDeploymentLogs

Used to fetch InstanceDeployment with specified logs

```js
const instanceDeployment: InstanceDeployment = await spheron.instance.getInstanceDeploymentLogs(
    deploymentId,
    {
      from: 0;
      to: 1000;
      logType: InstanceLogType.DEPLOYMENT_LOGS;
      search: searchString;
    });
```

Params:

- Id of the deployment.
- `logsOptions`:
  - `from`: from log 
  - `to`: to log
  - `logType`: log type to fetch (deployment logs/instance logs/instance events).
  - `search`: search string (optional)

Returns an `InstanceDeployment` object with filtered logs. For more details about InstanceDeployment object check [getInstanceDeployment section](/sdk/compute/#getInstanceDeployment-1)

---

### createFromMarketplace

Used to create new instance from marketplace app.

```js
const instanceCreate: MarketplaceInstanceResponse =
  await spheron.instance.createFromMarketplace(
    {
      marketplaceAppId: marketplaceAppId;
      environmentVariables: [
        {label: "User", value: "admin"},
        {label: "Password", value: "super secret password"},
        {label: "Database", value: "mydb" }
      ];
      machineImageId: machineId;
      region: "any";
    }
  );
```

Params:

- `createConfig`:
  - `marketplaceAppId`: Id of marketplace app. List of available apps can be aquierd from [get section under compute marketplace section](/sdk/compute/#get-3)
  - `environmentVariables`: list of variables for specified marketplace app
  - `machineImageId`: name of machine image which should be used for deploying instance. List of available can be aquierd from [get section under compute machine section](/sdk/compute/#get-4)
  - `region`: region in which to deploy instance. List of available can be acquired from [getRegions section under compute machine section](/sdk/compute/#getregions)

Returns `MarketplaceInstanceResponse` object, indicating instance deployment has started.

```js
interface MarketplaceInstanceResponse {
  marketplaceApp: MarketplaceApp; //marketplace app used
  marketplaceAppId: string; //marketplace app id
  clusterId: string; //id of a cluster instance belongs to
  instanceId: string; //instance id
  instanceDeploymentId: string; //deployment id
}
```

---

### getDomains

Used to get the domains of a project.

```js
const domains: Domain[] = await spheron.instance.getDomains(projectId);
```

Params:

- Id of the project.

Returns an array of deployment domains.

```js
interface Domain {
  id: string; // the id of the domain
  name: string; // the domain name
  verified: boolean; // true means that the domain is verified and that it will start serving the content
  link: string; // the link to which the domain points to
  type: DomainTypeEnum; // the type of the domain
  projectId: string; // the project id of which the domain is
  deploymentEnvironmentIds: string[]; //  the ids of the deployment environments for the domain. Whenever a deployment for the specified environment is done, the domain will be updated to point to the new link of the deployment.
};

enum DomainTypeEnum {
    DOMAIN = "domain",
    SUBDOMAIN = "subdomain",
    HANDSHAKE_DOMAIN = "handshake-domain",
    HANDSHAKE_SUBDOMAIN = "handshake-subdomain",
    ENS_DOMAIN = "ens-domain"
}
```

### getDomain

Used to get the domain of a project.

```js
const domain: Domain = await spheron.instance.getDomain(projectId, "test.com");
```

Params:

- Id of the project.
- Domain identifier. The domain identifier can be the domain id, or the domain name itself.

Returns the domain.

---

### addDomain

Used to add a new domain to a project.

```js
const domain: Domain = await spheron.instance.addDomain(projectId, {
  name: "domain.com",
  type: DomainTypeEnum.DOMAIN,
  deploymentEnvironments: ["Production"],
});
```

Params:

- Id of the project.
- `options`:
  - `name`: the domain name.
  - `type`: the domain type.
  - `deploymentEnvironments` ( optional ): name of the deployment environments. Whenever a deployment for the specified deployment environment executed, the domain will be updated to point to the newly deployed data.
  - `link` ( optional ): The `sitePreview` of a specific deployment of the same project. When this property is set, the domain will point to data of the specified deployment, and will not be updated when a new deployment is done.

<Callout type="info">
  **NOTE:** Ether `deploymentEnvironments` or `link` is required in the request
  body.
</Callout>

Returns the newly created domain. After a domain is created you need to call the [verifyDomain](/sdk/compute/#verifydomain) function for it to work.

---

### updateDomain

Used to update a domain of a project.

```js
const domain: Domain = await spheron.instance.updateDomain(
  projectId,
  domainId,
  {
    name: "test.com",
    deploymentEnvironments: ["Production"],
  }
);
```

Params:

- Id of the project.
- Domain identifier. The domain identifier can be the domain id, or the domain name itself.
- `options`:
  - `name`: the domain name.
  - `deploymentEnvironments` ( optional ): name of the deployment environments. Whenever a deployment for the specified deployment environment executed, the domain will be updated to point to the newly deployed data.
  - `link` ( optional ): The `sitePreview` of a specific deployment of the same project. When this property is set, the domain will point to data of the specified deployment, and will not be updated when a new deployment is done.

Returns the updated domain. If the domain name is updated you need to call the [verifyDomain](/sdk/compute/#verifydomain) function again.

---

### verifyDomain

Used to verify the domain, after which the content behind the domain will be cached on CDN.

```js
const domain: Domain = await spheron.instance.verifyDomain(projectId, domainId);
```

Params:

- Id of the project.
- Domain identifier. The domain identifier can be the domain id, or the domain name itself.

Returns the verified domain.

---

### deleteDomain

Used to delete a domain of a project.

```js
await spheron.instance.deleteDomain(projectId, domainId);
```

Params:

- Id of the project.
- Domain identifier. The domain identifier can be the domain id, or the domain name itself.

Method return type is void.

### triggerLatestLog

Used to trigger fetch of latest logs for instance.

```js
await spheron.instance.triggerLatestLog(instanceId);
```

Params:

- Id of the instance.

Returns the response indicating the fetching process has started.

```js
{
  message: string;
}
```
---

### triggerLatestHealth

Used to trigger fetch of latest helth status for instance.

```js
await spheron.instance.triggerLatestHealth(instanceId);
```

Params:

- Id of the instance.

Returns the response indicating the fetching process has started.

```js
{
  message: string;
}
```
---

## Compute Marketplace

The methods for working with marketplace apps are available on the `computeMarketplace` property of the `SpheronClient` object.

### getAll

Used to get all available compute marketplace apps.

```js
const marketplaceApps: MarketplaceApp[] =
  await spheron.computeMarketplace.getAll();
```

Method returns list of `MarketplaceApp` objects. For more details about `MarketplaceApp`check [get section under compute marketplace](/sdk/compute/#get-4)

### get

Used to deactivate a deployment environment.

```js
const marketplaceApp: MarketplaceApp =
  await spheron.computeMarketplace.get(marketplaceAppId);
```

Params:

- Id of the marketplace app.

Method returns `MarketplaceApp` object.

```js
interface MarketplaceApp {
  id: string; //id of a marketplace app
  name: string; //name of a marketplace app
  description: string; //description of a marketplace app
  category: MarketplaceCategoryEnum; //marketplace app category
  variables: MarketplaceAppVariable[]; //list of enironemt variables
};

enum MarketplaceCategoryEnum {
    DATABASE = "Database",
    NODE = "Node",
    TOOLS = "Tools"
};

interface MarketplaceAppVariable {
    name: string;
    defaultValue: string;
    label: string;
    required?: string;
    hidden: boolean;
};

interface MarketplaceAppPort {
    containerValue: number;
    defaultExposedValue: number;
};
```
---

### getCategories

Used to get available categories for marketplace apps.

```js
const categories: string[] = await spheron.computeMarketplace.getCategories();
```

Method returns list of available categories.

---

## Compute Machine

The methods for working with compute machines are available on the `computeMachine` property of the `SpheronClient` object.

### get

Used to get list of available compute machines.

```js
const computeMachines: ComputeMachine[] = await spheron.computeMachine.get({
  skip: 0,
  limit: 10,
  searchString: "2Gi"
});
```

Params:

- `options`:
  - `skip`: number of machines to skip.
  - `limit`: number of machines to take.
  - `searchString`: (optional) search string. Search for specific cpu/storage/memory.

Method returnns list of `ComputeMachine` objects.

```js
interface ComputeMachine {
  id: string; //id of compute machine
  name: string; //name of compute machine
  cpu: number; //compute machine cpu
  storage: string; //compute machine storage
  memory: string; //compute machine memeory
}
```

### getRegions

Used to get available regions.

```js
const regions: string[] = await spheron.computeMachine.getRegions();
```

Returns list of available regions.